# ============================================================================
# Website QA Agent — Claude Code + Puppeteer MCP
# ============================================================================
# Runs Claude Code with a headless browser to audit any website for issues.
# The audit prompt and target URL live in .agent/skills/qa-url/SKILL.md
#
# SETUP:
#   1. Copy this file to:        .github/workflows/agent-qa-url.yml
#   2. Customise the skill at:   .agent/skills/qa-url/SKILL.md
#   3. Add a repository secret:  ANTHROPIC_API_KEY or CLAUDE_CODE_OAUTH_TOKEN
#   4. Install the Claude App:   https://github.com/apps/claude
#   5. (Optional) Add secrets:   QA_USERNAME, QA_PASSWORD for authenticated testing
#
# TRIGGERS:
#   - Manual dispatch (with optional URL/prompt overrides)
#   - Daily at 05:00 UTC
#   - After a successful push to main (post-deploy)
# ============================================================================

name: Agent QA URL

on:
  # ── Manual trigger with optional overrides ──────────────────────────────
  workflow_dispatch:
    inputs:
      target_url:
        description: "Override target URL (leave blank to use SKILL.md)"
        required: false
        type: string
      prompt:
        description: "Override prompt (leave blank to use SKILL.md)"
        required: false
        type: string
      max_turns:
        description: "Max agent turns (controls cost/depth)"
        required: false
        type: number
        default: 200

  # ── Daily schedule ──────────────────────────────────────────────────────
  schedule:
    - cron: "0 5 * * *" # Every day at 05:00 UTC

  # ── After successful push to main (post-deploy) ────────────────────────
  push:
    branches: [main]

# Prevent concurrent runs — if a new push lands while QA is running,
# cancel the in-progress run and start fresh.
concurrency:
  group: agent-qa-url
  cancel-in-progress: true

env:
  SKILL_PATH: .agent/skills/qa-url/SKILL.md
  DEFAULT_MAX_TURNS: "200"

jobs:
  agent-qa-url:
    name: "Agent: QA URL"
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      issues: write

    steps:
      # ── 1. Checkout repo ────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Set up Node.js ───────────────────────────────────────────────
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # ── 3. Install Puppeteer MCP server ─────────────────────────────────
      - name: Install Puppeteer MCP server
        run: npm install -g @modelcontextprotocol/server-puppeteer

      # ── 4. Configure MCP for Claude Code ────────────────────────────────
      - name: Configure MCP settings
        run: |
          mkdir -p ~/.claude
          cat > ~/.claude/settings.json << 'EOF'
          {
            "mcpServers": {
              "puppeteer": {
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-puppeteer"],
                "env": {
                  "PUPPETEER_LAUNCH_OPTIONS": "{\"headless\": true, \"args\": [\"--no-sandbox\", \"--disable-setuid-sandbox\", \"--disable-dev-shm-usage\", \"--disable-gpu\"]}"
                }
              }
            }
          }
          EOF

      # ── 5. Ensure agent-qa-url label exists ─────────────────────────────
      - name: Create agent-qa-url label if missing
        run: gh label create agent-qa-url --color "D93F0B" --description "Agent QA URL" --force
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ── 6. Resolve configuration ────────────────────────────────────────
      - name: Resolve target URL
        id: config
        run: |
          # Extract TARGET_URL from skill file
          SKILL_URL=$(grep -oP '^TARGET_URL:\s*\K\S+' "${{ env.SKILL_PATH }}" || echo "")

          # Priority: dispatch input → skill file
          if [ -n "${{ inputs.target_url }}" ]; then
            TARGET_URL="${{ inputs.target_url }}"
          elif [ -n "$SKILL_URL" ]; then
            TARGET_URL="$SKILL_URL"
          else
            echo "::error::No target URL found. Set TARGET_URL in ${{ env.SKILL_PATH }} or pass as dispatch input."
            exit 1
          fi
          echo "target_url=$TARGET_URL" >> "$GITHUB_OUTPUT"

          # Max turns
          if [ -n "${{ inputs.max_turns }}" ] && [ "${{ inputs.max_turns }}" != "200" ]; then
            echo "max_turns=${{ inputs.max_turns }}" >> "$GITHUB_OUTPUT"
          else
            echo "max_turns=${{ env.DEFAULT_MAX_TURNS }}" >> "$GITHUB_OUTPUT"
          fi

      # ── 7. Build the prompt ─────────────────────────────────────────────
      - name: Build prompt
        run: |
          if [ -n "${{ inputs.prompt }}" ]; then
            # Manual override prompt
            printf '%s\n' '${{ inputs.prompt }}' > /tmp/qa_prompt.txt
          else
            # Read the full skill file and append execution context
            cat "${{ env.SKILL_PATH }}" > /tmp/qa_prompt.txt
            cat >> /tmp/qa_prompt.txt << PROMPTEOF

          ---

          RUNTIME CONTEXT:
          - Target URL: ${{ steps.config.outputs.target_url }}
          - Repository: ${{ github.repository }}
          - Trigger: ${{ github.event_name }}
          - Date: $(date -u +"%Y-%m-%d")
          PROMPTEOF

            # Conditionally add login credentials
            if [ -n "$QA_USERNAME" ]; then
              cat >> /tmp/qa_prompt.txt << CREDSEOF

          LOGIN CREDENTIALS (use these to test authenticated areas):
          - Username: $QA_USERNAME
          - Password: $QA_PASSWORD
          CREDSEOF
            fi

            cat >> /tmp/qa_prompt.txt << INSTREOF

          Use the Puppeteer browser tools (mcp__puppeteer__*) to navigate the site.
          Write all findings incrementally to /tmp/qa_url_manifest.md as described in the skill instructions.
          The repository is "${{ github.repository }}" and today's date is $(date -u +"%Y-%m-%d").
          Do NOT create a GitHub issue — a separate reporter agent will handle that.
          INSTREOF
          fi
        env:
          QA_USERNAME: ${{ secrets.QA_USERNAME }}
          QA_PASSWORD: ${{ secrets.QA_PASSWORD }}

      # ── 8. Install Claude Code CLI ────────────────────────────────────
      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      # ── 9. Debug — verify environment ──────────────────────────────────
      - name: Debug environment
        run: |
          echo "::group::System info"
          echo "Node: $(node --version)"
          echo "NPM: $(npm --version)"
          echo "Claude CLI: $(claude --version 2>&1 || echo 'NOT FOUND')"
          echo "::endgroup::"

          echo "::group::Auth check"
          if [ -n "$ANTHROPIC_API_KEY" ]; then
            echo "ANTHROPIC_API_KEY is set (${#ANTHROPIC_API_KEY} chars, starts with ${ANTHROPIC_API_KEY:0:7}...)"
          else
            echo "::warning::ANTHROPIC_API_KEY is NOT set"
          fi
          if [ -n "$CLAUDE_CODE_OAUTH_TOKEN" ]; then
            echo "CLAUDE_CODE_OAUTH_TOKEN is set (${#CLAUDE_CODE_OAUTH_TOKEN} chars, starts with ${CLAUDE_CODE_OAUTH_TOKEN:0:7}...)"
          else
            echo "::warning::CLAUDE_CODE_OAUTH_TOKEN is NOT set"
          fi
          echo "::endgroup::"

          echo "::group::Credentials check"
          if [ -n "$QA_USERNAME" ]; then
            echo "QA_USERNAME is set ($QA_USERNAME)"
          else
            echo "QA_USERNAME is NOT set (unauthenticated testing only)"
          fi
          if [ -n "$QA_PASSWORD" ]; then
            echo "QA_PASSWORD is set (${#QA_PASSWORD} chars)"
          else
            echo "QA_PASSWORD is NOT set"
          fi
          echo "::endgroup::"

          echo "::group::MCP settings"
          cat ~/.claude/settings.json
          echo "::endgroup::"

          echo "::group::Resolved config"
          echo "Target URL: ${{ steps.config.outputs.target_url }}"
          echo "Max turns:  ${{ steps.config.outputs.max_turns }}"
          echo "Trigger:    ${{ github.event_name }}"
          echo "::endgroup::"

          echo "::group::Prompt (first 80 lines)"
          head -80 /tmp/qa_prompt.txt
          echo "::endgroup::"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          QA_USERNAME: ${{ secrets.QA_USERNAME }}
          QA_PASSWORD: ${{ secrets.QA_PASSWORD }}

      # ── 10. Run Claude Code CLI in headless mode ────────────────────────
      - name: Run Claude Code QA agent
        id: claude_run
        continue-on-error: true
        run: |
          set -o pipefail
          echo "::group::Claude Code output"
          claude -p "$(cat /tmp/qa_prompt.txt)" \
            --max-turns "${{ steps.config.outputs.max_turns }}" \
            --allowedTools "Bash(git:*),Bash(echo:*),Bash(cat:*),Bash(grep:*),Bash(head:*),Bash(tail:*),Bash(date:*),Bash(curl:*),mcp__puppeteer__*" \
            --verbose \
            2>&1 | tee /tmp/qa_url_output_agent.txt
          EXIT_CODE=${PIPESTATUS[0]}
          echo "::endgroup::"
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          exit $EXIT_CODE
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          PUPPETEER_LAUNCH_OPTIONS: '{"headless": true, "args": ["--no-sandbox", "--disable-setuid-sandbox", "--disable-dev-shm-usage"]}'

      # ── 11. Upload artifacts ──────────────────────────────────────────
      - name: Upload Claude output and manifest
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-url-artifacts
          path: |
            /tmp/qa_url_output_agent.txt
            /tmp/qa_url_manifest.md
          retention-days: 14

      # ── 12. Reporter agent — creates GitHub issue from manifest ──────
      - name: Run reporter agent
        if: always()
        run: |
          echo "::group::Reporter agent output"
          claude -p "$(cat <<'REPORTEREOF'
          Read the file /tmp/qa_url_manifest.md. Create a GitHub issue from its contents in the repository "${{ github.repository }}".

          Title format: "Website QA Audit — <date from manifest front-matter>"

          Body format:
          - Start with a summary: target URL, date, number of pages audited, and number of findings
          - If the manifest does NOT contain a "## Status: Complete" marker, add a prominent note at the top: "⚠️ **Partial Audit** — The QA agent was interrupted before completing the full audit. The findings below are incomplete."
          - List all findings grouped by severity (Critical → High → Medium → Low), preserving the details from the manifest
          - Add a "Pages Audited" section listing all audited pages
          - If the manifest file is empty or missing, create an issue noting that the QA agent produced no output

          Use the label "agent-qa-url".
          REPORTEREOF
          )" \
            --max-turns 10 \
            --allowedTools "Bash(gh:*),Bash(cat:*),Bash(head:*),Bash(tail:*)" \
            --verbose \
            2>&1 | tee /tmp/qa_url_output_reporter.txt
          echo "::endgroup::"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ── 13. Summary ────────────────────────────────────────────────────
      - name: Post job summary
        if: always()
        run: |
          echo "## Agent QA URL Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Target URL:** ${{ steps.config.outputs.target_url }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Trigger:** \`${{ github.event_name }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Max turns:** ${{ steps.config.outputs.max_turns }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **QA agent exit code:** ${{ steps.claude_run.outputs.exit_code }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Check audit completeness
          if [ -f /tmp/qa_url_manifest.md ] && grep -q "## Status: Complete" /tmp/qa_url_manifest.md; then
            echo "- **Audit status:** ✅ Complete" >> "$GITHUB_STEP_SUMMARY"
          elif [ -f /tmp/qa_url_manifest.md ]; then
            echo "- **Audit status:** ⚠️ Partial (agent was interrupted)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- **Audit status:** ❌ No manifest produced" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ -f /tmp/qa_url_manifest.md ]; then
            echo "<details><summary>QA Manifest</summary>" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo '```markdown' >> "$GITHUB_STEP_SUMMARY"
            cat /tmp/qa_url_manifest.md >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "</details>" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [ -f /tmp/qa_url_output_agent.txt ]; then
            echo "<details><summary>Claude output (last 100 lines)</summary>" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            tail -100 /tmp/qa_url_output_agent.txt >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "</details>" >> "$GITHUB_STEP_SUMMARY"
          fi
