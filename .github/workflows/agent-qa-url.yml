# ============================================================================
# Website QA Agent — Claude Code + Puppeteer MCP
# ============================================================================
# Runs Claude Code with a headless browser to audit any website for issues.
# The audit prompt and target URL live in .agent/skills/qa-url/SKILL.md
#
# SETUP:
#   1. Copy this file to:        .github/workflows/agent-qa-url.yml
#   2. Customise the skill at:   .agent/skills/qa-url/SKILL.md
#   3. Add a repository secret:  ANTHROPIC_API_KEY
#   4. Install the Claude App:   https://github.com/apps/claude
#
# TRIGGERS:
#   - Manual dispatch (with optional URL/prompt overrides)
#   - Daily at 05:00 UTC
#   - After a successful push to main (post-deploy)
# ============================================================================

name: Agent QA URL

on:
  # ── Manual trigger with optional overrides ──────────────────────────────
  workflow_dispatch:
    inputs:
      target_url:
        description: "Override target URL (leave blank to use SKILL.md)"
        required: false
        type: string
      prompt:
        description: "Override prompt (leave blank to use SKILL.md)"
        required: false
        type: string
      max_turns:
        description: "Max agent turns (controls cost/depth)"
        required: false
        type: number
        default: 200

  # ── Daily schedule ──────────────────────────────────────────────────────
  schedule:
    - cron: "0 5 * * *" # Every day at 05:00 UTC

  # ── After successful push to main (post-deploy) ────────────────────────
  push:
    branches: [main]

# Prevent concurrent runs — if a new push lands while QA is running,
# cancel the in-progress run and start fresh.
concurrency:
  group: agent-qa-url
  cancel-in-progress: true

env:
  SKILL_PATH: .agent/skills/qa-url/SKILL.md
  DEFAULT_MAX_TURNS: "200"

jobs:
  agent-qa-url:
    name: "Agent: QA URL"
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: read
      issues: write

    steps:
      # ── 1. Checkout repo ────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Set up Node.js ───────────────────────────────────────────────
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # ── 3. Install Puppeteer MCP server ─────────────────────────────────
      - name: Install Puppeteer MCP server
        run: npm install -g @modelcontextprotocol/server-puppeteer

      # ── 4. Configure MCP for Claude Code ────────────────────────────────
      - name: Configure MCP settings
        run: |
          mkdir -p ~/.claude
          cat > ~/.claude/settings.json << 'EOF'
          {
            "mcpServers": {
              "puppeteer": {
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-puppeteer"],
                "env": {
                  "PUPPETEER_LAUNCH_OPTIONS": "{\"headless\": true, \"args\": [\"--no-sandbox\", \"--disable-setuid-sandbox\", \"--disable-dev-shm-usage\", \"--disable-gpu\"]}"
                }
              }
            }
          }
          EOF

      # ── 5. Ensure agent-qa-url label exists ─────────────────────────────────
      - name: Create agent-qa-url label if missing
        run: gh label create agent-qa-url --color "D93F0B" --description "Agent QA URL" --force
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ── 6. Resolve configuration ────────────────────────────────────────
      - name: Resolve target URL
        id: config
        run: |
          # Extract TARGET_URL from skill file
          SKILL_URL=$(grep -oP '^TARGET_URL:\s*\K\S+' "${{ env.SKILL_PATH }}" || echo "")

          # Priority: dispatch input → skill file
          if [ -n "${{ inputs.target_url }}" ]; then
            TARGET_URL="${{ inputs.target_url }}"
          elif [ -n "$SKILL_URL" ]; then
            TARGET_URL="$SKILL_URL"
          else
            echo "::error::No target URL found. Set TARGET_URL in ${{ env.SKILL_PATH }} or pass as dispatch input."
            exit 1
          fi
          echo "target_url=$TARGET_URL" >> "$GITHUB_OUTPUT"

          # Max turns
          if [ -n "${{ inputs.max_turns }}" ] && [ "${{ inputs.max_turns }}" != "15" ]; then
            echo "max_turns=${{ inputs.max_turns }}" >> "$GITHUB_OUTPUT"
          else
            echo "max_turns=${{ env.DEFAULT_MAX_TURNS }}" >> "$GITHUB_OUTPUT"
          fi

      # ── 7. Build the prompt ─────────────────────────────────────────────
      - name: Build prompt
        run: |
          if [ -n "${{ inputs.prompt }}" ]; then
            # Manual override prompt
            printf '%s\n' '${{ inputs.prompt }}' > /tmp/qa_prompt.txt
          else
            # Read the full skill file and append execution context
            cat "${{ env.SKILL_PATH }}" > /tmp/qa_prompt.txt
            cat >> /tmp/qa_prompt.txt << PROMPTEOF

          ---

          RUNTIME CONTEXT:
          - Target URL: ${{ steps.config.outputs.target_url }}
          - Repository: ${{ github.repository }}
          - Trigger: ${{ github.event_name }}
          - Date: $(date -u +"%Y-%m-%d")

          Use the Puppeteer browser tools (mcp__puppeteer__*) to navigate the site.
          When finished, use the gh CLI to create a GitHub issue in the repository
          "${{ github.repository }}" with the label "qa-audit".
          Include today's date in the issue title, e.g. "Website QA Audit — $(date -u +"%Y-%m-%d")".
          PROMPTEOF
          fi

      # ── 8. Run Claude Code CLI in headless mode ─────────────────────────
      - name: Run Claude Code QA agent
        run: |
          claude -p "$(cat /tmp/qa_prompt.txt)" \
            --max-turns "${{ steps.config.outputs.max_turns }}" \
            --allowedTools "Bash(git:*),Bash(gh:*),Bash(echo:*),Bash(cat:*),Bash(grep:*),Bash(head:*),Bash(tail:*),Bash(date:*),mcp__puppeteer__*" \
            --verbose
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PUPPETEER_LAUNCH_OPTIONS: '{"headless": true, "args": ["--no-sandbox", "--disable-setuid-sandbox", "--disable-dev-shm-usage"]}'
